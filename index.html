<!doctype html> 
<html lang="en"> 
<head> 
	<meta charset="UTF-8" />
	<title>Testing Phaser</title>
	<script type="text/javascript" src="js/phaser.min.js"></script>
    <script type="text/javascript" src="Tile.js"></script>
    <script type="text/javascript" src="Game.js"></script>
    <script type="text/javascript" src="Board.js"></script>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

    <script type="text/javascript">

        var game = new Phaser.Game(225, 300, Phaser.CANVAS, '', { preload: preload, create: create, update: update });
        var tiles = [];

        BOMB_STATE = 0;
        EXPLODED_BOMB_STATE = 1;
        HIDDEN_STATE = 3;
        REVEALED_STATE = 4;
        FLAGGED_STATE = 2;

        function preload()
        {
            this.game.load.atlasJSONArray('tile','assets/minesweeper.png','assets/minesweeper.json');
        }

        function create()
        {
            build_board();
            set_bombs(10);
            set_bomb_counts();
        }

        function update() 
        {
            for(var i=0; i<tiles.length; i++){
                if (tiles[i]["sprite"].input.pointerDown(game.input.activePointer.id)) {

                    // Tile was clicked
                    // Is the tile a bomb?
                    if(tiles[i].bomb == true){
                        reveal_all_bombs();
                        tiles[i]["sprite"].frame = EXPLODED_BOMB_STATE;
                        tiles[i]["state"] = EXPLODED_BOMB_STATE;
                    } else {
                        // Do I have a bomb count?
                        tiles[i]["sprite"].frame = REVEALED_STATE;
                        tiles[i]["state"] = REVEALED_STATE;
                        tiles[i]["text"].alpha = 1.0;
                    }
                }
            }
        }

        function build_board()
        {
            var style = { font: "18px Arial", fill: "#ffffff", align: "center" };
            for(var i=0; i<225; i+=25) {
                for (var j = 0; j < 225; j += 25) {
                    x = {
                        "sprite": game.add.sprite(i,j,'tile'),
                        "text": game.add.text(i+7, j+2, "0", style),
                        "state": HIDDEN_STATE,
                        "bomb": false,
                        "bomb_count": 0
                    };
                    x["text"].alpha = 0.0;
                    x["sprite"].input.start();
                    tiles.push(x);
                    x["sprite"].loadTexture('tile',HIDDEN_STATE);
                }
            }
        }

        function set_bomb_counts()
        {
            for(var i=0; i<tiles.length; i++){
                var bomb_count = 0
                //top
                if(i-9>=0){
                    if(tiles[i-9]["bomb"] == true){
                        bomb_count = bomb_count + 1;
                    }
                }
                //top-left
                if(i-10>=0){
                    if(tiles[i-10]["bomb"] == true){
                        bomb_count = bomb_count + 1;
                    }
                }
                //top-right
                if(i-8>=0){
                    if(tiles[i-8]["bomb"] == true){
                        bomb_count = bomb_count + 1;
                    }
                }
                //left
                if(i-1>=0){
                    if(tiles[i-1]["bomb"] == true){
                        bomb_count = bomb_count + 1;
                    }
                }
                //right
                if(i+1<tiles.length){
                    if(tiles[i+1]["bomb"] == true){
                        bomb_count = bomb_count + 1;
                    }
                }
                //bottom-left
                if(i+8<tiles.length){
                    if(tiles[i+8]["bomb"] == true){
                        bomb_count = bomb_count + 1;
                    }
                }
                //bottom-right
                if(i+9<tiles.length){
                    if(tiles[i+9]["bomb"] == true){
                        bomb_count = bomb_count + 1;
                    }
                }
                //bottom
                if(i+10<tiles.length){
                    if(tiles[i+10]["bomb"] == true){
                        bomb_count = bomb_count + 1;
                    }
                }
                tiles[i]["bomb_count"] = bomb_count;
                tiles[i]["text"].setText(""+bomb_count);
                tiles[i]["text"].alpha = 1.0;
            }
        }

        function set_bombs(quantity)
        {
            var bombs = 0;
            while(bombs < quantity){
                chosen_tile = tiles[Math.floor((Math.random() * tiles.length) + 0)];
                if(chosen_tile["bomb"] == false){
                    chosen_tile["bomb"] = true;
                    bombs = bombs + 1;
                }
            }
        }

        function reveal_all_bombs()
        {
            for(var i=0; i<tiles.length; i++){
                if(tiles[i]["bomb"] == true){
                    tiles[i]["sprite"].frame = BOMB_STATE;
                    tiles[i]["state"] = BOMB_STATE;
                }
            }
        }

    </script>

</body>
</html>