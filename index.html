<!doctype html> 
<html lang="en"> 
<head> 
	<meta charset="UTF-8" />
	<title>Testing Phaser</title>
	<script type="text/javascript" src="js/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

    <script type="text/javascript">

        var game = new Phaser.Game(800, 550, Phaser.CANVAS, '', { preload: preload, create: create, update: update });
        var tiles = [];

        BOMB_STATE = 7;
        EXPLODED_BOMB_STATE = 1;
        HIDDEN_STATE = [3,4,5,6];
        REVEALED_STATE = 0;
        FLAGGED_STATE = 2;

        tiles_width = 30;
        tiles_height = 16;
        bomb_count = 99;

        input_enabled = true;

        function preload()
        {
            this.game.load.atlasJSONArray('tile','assets/tiles.png','assets/tiles.json');
            this.game.load.image('bg','assets/bg.png');
            this.game.load.image('tank','assets/tank.png');
        }

        function create()
        {
            game.add.sprite(0,0,'bg');
            build_board();
            set_bombs(bomb_count);
            set_bomb_counts();
            shiftKey = game.input.keyboard.addKey(Phaser.Keyboard.SHIFT);


        }

        function update() 
        {
            if(game_won()){

            } else {
                if(input_enabled){
                    for(var i=0; i<tiles.length; i++){
                        //Clicking
                        //Flagging?
                        if (tiles[i]["sprite"].input.pointerDown(game.input.activePointer.id)) {
                            if (shiftKey.isDown){
                                if(tiles[i]["flagged"] == false){
                                    tiles[i]["sprite"].frame = FLAGGED_STATE;
                                    tiles[i]["state"] = FLAGGED_STATE;
                                    tiles[i]["flagged"] = true;
                                } else {
                                    tiles[i]["sprite"].frame = HIDDEN_STATE;
                                    tiles[i]["state"] = HIDDEN_STATE;
                                    tiles[i]["flagged"] = false;
                                }
                            } else {
                                // Tile was clicked
                                // Is the tile a bomb?
                                if(tiles[i]["flagged"] == false) {

                                    // Does the tile have a bomb count?
                                    if(tiles[i]["bomb"] == true){
                                        reveal_all_bombs();
                                        tiles[i]["sprite"].frame = EXPLODED_BOMB_STATE;
                                        tiles[i]["state"] = EXPLODED_BOMB_STATE;
                                        input_enabled = false;
                                    } else {
                                        tiles[i]["sprite"].frame = REVEALED_STATE;
                                        tiles[i]["state"] = REVEALED_STATE;

                                        if(tiles[i]["bomb_count"] > 0){
                                            tiles[i]["text"].alpha = 1.0;
                                        } else if(tiles[i]["bomb_count"] == 0){
                                            tiles[i]["text"].alpha = 0.0;
                                            reveal_all_empty_neighbors_starting_from(i);
                                        }
                                    }
                                } else {
                                    alert('hi!');
                                }
                            }
                        }
                    }
                }
            }
        }

        function game_won()
        {
            var revealed_tiles = 0;
            for(var i=0; i<tiles.length; i++){
                if(tiles[i]["state"] == REVEALED_STATE){
                    revealed_tiles = revealed_tiles + 1;
                }
            }

            reveal_tiles_label.setText(revealed_tiles);
            total_tiles_label.setText(tiles_width * tiles_height - revealed_tiles - bomb_count);

            return ((tiles_width * tiles_height) - bomb_count) == revealed_tiles
        }

        function reveal_all_empty_neighbors_starting_from(starting_index)
        {
            var neighbors = get_neighbors_for(starting_index);

            while(neighbors.length > 0){

                var tile = neighbors.shift();

                if(tile["bomb_count"] == 0 && tile["bomb"] == false && tile["flagged"] == false){
                    var new_neighbors = get_neighbors_for(tile["index"]);
                    tile["text"].alpha = 0.0;
                    for(var j=0; j<new_neighbors.length; j++){
                        neighbors.push(new_neighbors[j]);
                    }
                }

                tile["sprite"].frame = REVEALED_STATE;
                tile["state"] = REVEALED_STATE;
                if(tile["bomb_count"] != 0){
                    tile["text"].alpha = 1.0;
                }
            }
        }

        function get_neighbors_for(index)
        {
            var neighbors = [];

            var indices = [index-tiles_width-1,index-tiles_width,index-tiles_width+1,index-1,index+1,index+tiles_width-1,index+tiles_width,index+tiles_width+1];

            for(var i=0; i<indices.length; i++){
                if(i < 4){
                    if(indices[i] > 0 && tiles[indices[i]]["checked"] == false){
                        neighbors.push(tiles[indices[i]]);
                        tiles[indices[i]]["checked"] = true;
                    }
                } else {
                    if(indices[i] < tiles.length && tiles[indices[i]]["checked"] == false){
                        neighbors.push(tiles[indices[i]]);
                        tiles[indices[i]]["checked"] = true;
                    }
                }
            }

            return neighbors;
        }

        function build_board()
        {
            var style = { font: "18px Arial", fill: "#ffffff", align: "center" };
            reveal_tiles_label = game.add.text(400, 50, "0", style);
            total_tiles_label = game.add.text(350,50,":)",style);
            var index_count = 0;
            for(var j = 100; j < (tiles_height*25)+100; j += 25) {
                for (var i=25; i<(tiles_width*25)+25; i+=25) {
                    x = {
                        "sprite": game.add.sprite(i,j,'tile'),
                        "text": game.add.text(i+7, j+2, "0", style),
                        "state": HIDDEN_STATE,
                        "bomb": false,
                        "bomb_count": 0,
                        "index": index_count,
                        "checked": false,
                        "flagged": false
                    };
                    x["text"].alpha = 0.0;
                    x["sprite"].input.start();
                    tiles.push(x);
                    x["sprite"].loadTexture('tile',HIDDEN_STATE[Math.floor((Math.random() * 4) + 0)]);
                    index_count = index_count + 1;
                }
            }
        }

        function set_bomb_counts()
        {
            for(var i=0; i<tiles.length; i++){
                var bomb_count = 0
                //top
                if(i-tiles_width>=0){
                    if(tiles[i-tiles_width]["bomb"] == true){
                        bomb_count = bomb_count + 1;
                    }
                }
                //top-left
                if((i-tiles_width-1)>=0){
                    if(tiles[i-tiles_width-1]["bomb"] == true){
                        bomb_count = bomb_count + 1;
                    }
                }
                //top-right
                if((i-tiles_width+1)>=0){
                    if(tiles[i-tiles_width+1]["bomb"] == true){
                        bomb_count = bomb_count + 1;
                    }
                }
                //left
                if(i-1>=0){
                    if(tiles[i-1]["bomb"] == true){
                        bomb_count = bomb_count + 1;
                    }
                }
                //right
                if(i+1<tiles.length){
                    if(tiles[i+1]["bomb"] == true){
                        bomb_count = bomb_count + 1;
                    }
                }
                //bottom-left
                if((i+tiles_width-1)<tiles.length){
                    if(tiles[i+tiles_width-1]["bomb"] == true){
                        bomb_count = bomb_count + 1;
                    }
                }
                //bottom-right
                if((i+tiles_width+1)<tiles.length){
                    if(tiles[i+tiles_width+1]["bomb"] == true){
                        bomb_count = bomb_count + 1;
                    }
                }
                //bottom
                if(i+tiles_width<tiles.length){
                    if(tiles[i+tiles_width]["bomb"] == true){
                        bomb_count = bomb_count + 1;
                    }
                }
                tiles[i]["bomb_count"] = bomb_count;
                tiles[i]["text"].setText(""+bomb_count);
                //tiles[i]["text"].setText(tiles[i]["index"]);
                //tiles[i]["text"].alpha = 1.0;
            }
        }

        function set_bombs(quantity)
        {
            var bombs = 0;
            while(bombs < quantity){
                chosen_tile = tiles[Math.floor((Math.random() * tiles.length) + 0)];
                if(chosen_tile["bomb"] == false){
                    chosen_tile["bomb"] = true;
                    bombs = bombs + 1;
                }
            }
        }

        function reveal_all_bombs()
        {
            for(var i=0; i<tiles.length; i++){
                if(tiles[i]["bomb"] == true){
                    tiles[i]["sprite"].frame = BOMB_STATE;
                    tiles[i]["state"] = BOMB_STATE;
                }
            }
        }

    </script>

</body>
</html>