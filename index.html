<!doctype html> 
<html lang="en"> 
<head> 
	<meta charset="UTF-8" />
	<title>Testing Phaser</title>
	<script type="text/javascript" src="js/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

    <script type="text/javascript">

        var game = new Phaser.Game(800, 550, Phaser.CANVAS, '', { preload: preload, create: create, update: update });
        var tiles = [];

        BOMB_STATE = 7;
        EXPLODED_BOMB_STATE = 1;
        HIDDEN_STATE = [3,4,5,6];
        REVEALED_STATE = 0;
        FLAGGED_STATE = 2;

        tiles_width = 30;
        tiles_height = 16;
        bomb_count = 99;

        function preload()
        {
            this.game.load.atlasJSONArray('tile','assets/tiles.png','assets/tiles.json');
        }

        function create()
        {
            build_board();
            set_bombs(99);
            set_bomb_counts();
        }

        function update() 
        {
            for(var i=0; i<tiles.length; i++){
                if (tiles[i]["sprite"].input.pointerDown(game.input.activePointer.id)) {

                    // Tile was clicked
                    // Is the tile a bomb?
                    if(tiles[i].bomb == true){
                        reveal_all_bombs();
                        tiles[i]["sprite"].frame = EXPLODED_BOMB_STATE;
                        tiles[i]["state"] = EXPLODED_BOMB_STATE;
                    } else {
                        // Does the tile have a bomb count?
                        tiles[i]["sprite"].frame = REVEALED_STATE;
                        tiles[i]["state"] = REVEALED_STATE;

                        if(tiles[i]["bomb_count"] > 0){
                            tiles[i]["text"].alpha = 1.0;
                        } else if(tiles[i]["bomb_count"] == 0){
                            reveal_all_empty_neighbors_starting_from(i);
                        }
                    }
                }
            }
        }

        function reveal_all_empty_neighbors_starting_from(i)
        {
            var neighbors = [];
            neighbors.push(i);

            while(neighbors.length > 0) {
                i = neighbors.shift()["index"];

                //Reveal all neighbors
                if(i-10 > 0){
                    if(tiles[i-10]["bomb_count"] == 0 && tiles[i-10]["checked"] == false) {
                        neighbors.push(i-10);
                    }
                    tiles[i-10]["sprite"].frame = REVEALED_STATE;
                    tiles[i-10]["state"] = REVEALED_STATE;
                    tiles[i-10]["checked"] = true;
                }

                if(i-9 > 0){
                    if(tiles[i-9]["bomb_count"] == 0 && tiles[i-9]["checked"] == false) {
                        neighbors.push(i-9);
                    }
                    tiles[i-9]["sprite"].frame = REVEALED_STATE;
                    tiles[i-9]["state"] = REVEALED_STATE;
                    tiles[i-9]["checked"] = true;
                }

                if(i-8 > 0){
                    if(tiles[i-8]["bomb_count"] == 0 && tiles[i-8]["checked"] == false) {
                        neighbors.push(i-8);
                    }
                    tiles[i-8]["sprite"].frame = REVEALED_STATE;
                    tiles[i-8]["state"] = REVEALED_STATE;
                    tiles[i-8]["checked"] = true;
                }

                if(i-1 > 0){
                    if(tiles[i-1]["bomb_count"] == 0 && tiles[i-1]["checked"] == false) {
                        neighbors.push(i-1);
                    }
                    tiles[i-1]["sprite"].frame = REVEALED_STATE;
                    tiles[i-1]["state"] = REVEALED_STATE;
                    tiles[i-1]["checked"] = true;
                }

                if(i+1 < tiles.length){
                    if(tiles[i+1]["bomb_count"] == 0 && tiles[i+1]["checked"] == false) {
                        neighbors.push(i+1);
                    }
                    tiles[i+1]["sprite"].frame = REVEALED_STATE;
                    tiles[i+1]["state"] = REVEALED_STATE;
                    tiles[i+1]["checked"] = true;
                }

                if(i+8 < tiles.length){
                    if(tiles[i+8]["bomb_count"] == 0 && tiles[i+8]["checked"] == false) {
                        neighbors.push(i+8);
                    }
                    tiles[i+8]["sprite"].frame = REVEALED_STATE;
                    tiles[i+8]["state"] = REVEALED_STATE;
                }

                if(i+9 > 0){
                    if(tiles[i+9]["bomb_count"] == 0 && tiles[i+9]["checked"] == false) {
                        neighbors.push(i+9);
                    }
                    tiles[i+9]["sprite"].frame = REVEALED_STATE;
                    tiles[i+9]["state"] = REVEALED_STATE;
                    tiles[i+9]["checked"] = true;
                }

                if(i+10 > 0){
                    if(tiles[i+10]["bomb_count"] == 0 && tiles[i+10]["checked"] == false) {
                        neighbors.push(i+10);
                    }
                    tiles[i+10]["sprite"].frame = REVEALED_STATE;
                    tiles[i+10]["state"] = REVEALED_STATE;
                    tiles[i+10]["checked"] = true;
                }

            }

            //Reset for next time
            for(var i=0; i<tiles.length; i++){
                tiles[i]["checked"] = false;
            }

        }

        function build_board()
        {
            var style = { font: "18px Arial", fill: "#ffffff", align: "center" };
            var index_count = 0;
            for(var i=25; i<(tiles_width*25)+25; i+=25) {
                for (var j = 100; j < (tiles_height*25)+100; j += 25) {
                    x = {
                        "sprite": game.add.sprite(i,j,'tile'),
                        "text": game.add.text(i+7, j+2, "0", style),
                        "state": HIDDEN_STATE,
                        "bomb": false,
                        "bomb_count": 0,
                        "index": index_count,
                        "checked": false
                    };
                    x["text"].alpha = 0.0;
                    x["sprite"].input.start();
                    tiles.push(x);
                    x["sprite"].loadTexture('tile',HIDDEN_STATE[Math.floor((Math.random() * 4) + 0)]);
                    index_count = index_count + 1;
                }
            }
        }

        function set_bomb_counts()
        {
            for(var i=0; i<tiles.length; i++){
                var bomb_count = 0
                //top
                if(i-9>=0){
                    if(tiles[i-9]["bomb"] == true){
                        bomb_count = bomb_count + 1;
                    }
                }
                //top-left
                if(i-10>=0){
                    if(tiles[i-10]["bomb"] == true){
                        bomb_count = bomb_count + 1;
                    }
                }
                //top-right
                if(i-8>=0){
                    if(tiles[i-8]["bomb"] == true){
                        bomb_count = bomb_count + 1;
                    }
                }
                //left
                if(i-1>=0){
                    if(tiles[i-1]["bomb"] == true){
                        bomb_count = bomb_count + 1;
                    }
                }
                //right
                if(i+1<tiles.length){
                    if(tiles[i+1]["bomb"] == true){
                        bomb_count = bomb_count + 1;
                    }
                }
                //bottom-left
                if(i+8<tiles.length){
                    if(tiles[i+8]["bomb"] == true){
                        bomb_count = bomb_count + 1;
                    }
                }
                //bottom-right
                if(i+9<tiles.length){
                    if(tiles[i+9]["bomb"] == true){
                        bomb_count = bomb_count + 1;
                    }
                }
                //bottom
                if(i+10<tiles.length){
                    if(tiles[i+10]["bomb"] == true){
                        bomb_count = bomb_count + 1;
                    }
                }
                tiles[i]["bomb_count"] = bomb_count;
                tiles[i]["text"].setText(""+bomb_count);
                tiles[i]["text"].alpha = 0.0;
            }
        }

        function set_bombs(quantity)
        {
            var bombs = 0;
            while(bombs < quantity){
                chosen_tile = tiles[Math.floor((Math.random() * tiles.length) + 0)];
                if(chosen_tile["bomb"] == false){
                    chosen_tile["bomb"] = true;
                    bombs = bombs + 1;
                }
            }
        }

        function reveal_all_bombs()
        {
            for(var i=0; i<tiles.length; i++){
                if(tiles[i]["bomb"] == true){
                    tiles[i]["sprite"].frame = BOMB_STATE;
                    tiles[i]["state"] = BOMB_STATE;
                }
            }
        }

    </script>

</body>
</html>